# k8s/base/jobs/django-migrate-job.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: django-migrate
spec:
  backoffLimit: 6  # Allow more retries for database connectivity
  ttlSecondsAfterFinished: 3600
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: migrate
          image: docker.io/carrotdevstar/optimus-prime:latest
          imagePullPolicy: IfNotPresent
          envFrom:
            - configMapRef:
                name: django-config
            - secretRef:
                name: django-secret
          command:
            - /bin/bash
            - -c
            - |
              # Simple retry loop with Django's check command
              for i in {1..30}; do
                if python manage.py check --database default 2>/dev/null; then
                  echo "âœ… Database connection successful"
                  break
                fi
                echo "â³ Attempt $i/30: Waiting for database..."
                sleep 5
              done
              echo "ğŸš€ Running migrations..."
              python manage.py migrate --noinput
              echo "âœ… Migrations completed successfully!"